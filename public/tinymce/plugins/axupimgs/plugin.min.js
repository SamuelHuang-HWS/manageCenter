tinymce.PluginManager.add('axupimgs', function(editor, url) {
	var pluginName='多图片上传';
	window.axupimgs={}; //扔外部公共变量，也可以扔一个自定义的位置

	var baseURL=tinymce.baseURL;
	var iframe1 = baseURL+'/plugins/axupimgs/upfiles.html';
    axupimgs.images_upload_handler = editor.getParam('images_upload_handler', undefined, 'function');
    axupimgs.images_upload_base_path = editor.getParam('images_upload_base_path', '', 'string');
    axupimgs.axupimgs_filetype = editor.getParam('axupimgs_filetype', '.png,.gif,.jpg,.jpeg', 'string');
	axupimgs.res=[];
	var openDialog = function() {
		return editor.windowManager.openUrl({
			title: pluginName,
			size: 'large',
			url:iframe1,
			buttons: [
				{
					type: 'cancel',
					text: 'Close'
				},
				{
					type: 'custom',
					text: 'Save',
					name: 'save',
					primary: true
				},
			],
			onAction: function (api, details) {
				switch (details.name) {
					case 'save':
						var html = '';
						var imgs = axupimgs.res;
						var len = imgs.length;
						for(let i=0;i<len;i++){
							if( imgs[i].url ){
								html += '<img src="'+imgs[i].url+'" />';
							}
						}
						editor.insertContent(html);
						axupimgs.res=[];
						api.close();
						break;
					default:
						break;
				}

			}
		});
	};

	editor.ui.registry.getAll().icons.axupimgs || editor.ui.registry.addIcon('axupimgs','<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n' +
    '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n' +
    '<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="80px" height="20px" viewBox="0 0 80 20" enable-background="new 0 0 80 20" xml:space="preserve">  <image id="image0" width="80" height="20" x="0" y="0"\n' +
    '    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAUCAMAAAAtBkrlAAABOGlDQ1BpY2MAAHjaY2BgEkgsKMhh\n' +
    'YWBgyM0rKQpyd1KIiIxSYH/CwM7AxiDIwMEgl5hcXOAYEOADVMIAo1HBt2sMjCD6si7IrKk/o2vW\n' +
    'qMYqO4rJHGVwT+dgwA+4UlKLk4H0HyBOSS4oKmFgYEwAspXLSwpA7BYgW6QI6CggewaInQ5hrwGx\n' +
    'kyDsA2A1IUHOQPYVIFsgOSMxBch+AmTrJCGJpyOxofaC3RBobGRuGe5u6sRAXVCSWlECop3zCyqL\n' +
    'MtMzShQcgSGUquCZl6yno2BkYGTAwAAKb4jqzzfA4cgoxoEQawSGi208KHARYj6vGRg27mJg4L2H\n' +
    'EFN/D/TScwaGIzUFiUWJcAcwfmMpTjM2grC5tzMwsE77//9zOAMDuyYDw9/r////3v7//99lDAzM\n' +
    'txgYDnwDAINDX0AzO3RkAAAAIGNIUk0AAHomAACAhAAA+gAAAIDoAAB1MAAA6mAAADqYAAAXcJy6\n' +
    'UTwAAAF3UExURfb29sfHx2tra1tbW8XFxevr67e3t/X19fHx8fPz883NzdfX1319faOjo7+/v21t\n' +
    'bba2tl5eXpiYmHR0dImJib29vZycnK+vr8bGxoKCgp+fn/Ly8qCgoLu7u8vLy4SEhMHBwerq6rS0\n' +
    'tMPDw+np6djY2Hl5eeHh4ZqamlxcXKSkpIuLi5KSkoaGhn9/f9/f32FhYXd3d4GBgY6OjmRkZGBg\n' +
    'YHNzc+7u7ufn57KysrGxsampqWxsbNDQ0HV1ddnZ2fDw8LW1tXZ2dnJycp2dnaGhoZWVle3s7YCA\n' +
    'gKKiotXV1aWlpd7e3oWFhe/v7+jo6MrJyoiIiJaWlsjIyHt7e2pqaqioqJOTk8zMzLi4uG9vb42N\n' +
    'jZCQkK6urtTU1Lq6utzb3JmZmeLi4mZmZmlpaW5ubry8vKqqqnBwcMTExGVlZeTk5ZGRkc7OzmNj\n' +
    'Y8/Pz35+foeHh5ubm+bm5mdnZ3x8fMLCwl9fX3FxcWhoaNHR0ePj4////4ixADwAAAABYktHRHzR\n' +
    'tiBfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5AcIADItnjoPzwAAAlZJREFUOMvV1Olz\n' +
    '0kAUAPBHICYkQJAI5Q6hEDAitKDcSEurWE6lWLSixdZqW1pv69F/3s1J4tQZZ/SDvg+7eZPkN+9l\n' +
    'NwvwH4QFsxoCs/wxiNmMmQ1TL/CfHrtC/Jog7WigaDWzohoNdVnV2eEEF6OEW8qvkgvAw+rhkfJr\n' +
    'XjT4lnQB8+t1LUA8EAzheDiI43hIB/2RSCQKwMV4Pr7Mo4hxvw0CkUgmk4IbDUkilU5f96RFYG9k\n' +
    'bmYRGIXcymo+X4DopeBlLacypF0QmFvC7aIglMqVqrVaqwObg4YMUsyd5lphXQNbHMcxGxxXNZUE\n' +
    'oc27IS0l7mXb0G55wXtf/nipFUgxC3Cr0yw6uqCBIqVEzwSG+oUCN9BTZ2OYDZdLEM7npDWsG8EH\n' +
    'na7jYbA1orZlMBszrrkmkH0RQBwvCqYf7cAkAhCrPwZ4Mobcrg7anrqjNZ7wT70yiI2eSeHVQTwz\n' +
    'KpGcKGVdHRzZnlOlyd5sOEoMALbSMNtYtAwwqBaDassD64sgisJYA/dbvimbF80Ftw/wxMvEZO9w\n' +
    'n+2gNPAK6FUDWHtN23sqSB/KbzQ0MHl0jCo7mZvB9QKEN1HLzm78FODsTQnevjOAqfj73dNjBfR9\n' +
    'MINMQ+71aG4Che3hwUcE9pj2pyF8TgMsTYHNcmMJPJc29dzl5s8RSH+hzeBMmcWvZQPYxIiSKyF+\n' +
    'i0Igt5yw1PlK/+Q7sBGqKoGM9ucxCOR2wARifrUmsVg2HA7SXrFXYsqRQM7g4gwtzSwEA3TDcqGt\n' +
    '3AX6I1LqsTF3KfNfP77+8fgB+5Bck3LrmswAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjAtMDctMDdU\n' +
    'MTY6NTA6NDUrMDg6MDDkII6XAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIwLTA3LTA3VDE2OjUwOjQ1\n' +
    'KzA4OjAwlX02KwAAACh0RVh0aWNjOmNvcHlyaWdodABDb3B5cmlnaHQgQXBwbGUgSW5jLiwgMjAy\n' +
    'MAq63rAAAAAZdEVYdGljYzpkZXNjcmlwdGlvbgBRMzI3OVdHNUIOlSfgAAAAIHRFWHRzb2Z0d2Fy\n' +
    'ZQBodHRwczovL2ltYWdlbWFnaWNrLm9yZ7zPHZ0AAAAYdEVYdFRodW1iOjpEb2N1bWVudDo6UGFn\n' +
    'ZXMAMaf/uy8AAAAXdEVYdFRodW1iOjpJbWFnZTo6SGVpZ2h0ADIw3+GomQAAABZ0RVh0VGh1bWI6\n' +
    'OkltYWdlOjpXaWR0aAA4MN2hgJ4AAAAZdEVYdFRodW1iOjpNaW1ldHlwZQBpbWFnZS9wbmc/slZO\n' +
    'AAAAF3RFWHRUaHVtYjo6TVRpbWUAMTU5NDExMTg0NYQXgd0AAAASdEVYdFRodW1iOjpTaXplADE5\n' +
    'NDRCQlRRlLcAAABGdEVYdFRodW1iOjpVUkkAZmlsZTovLy9hcHAvdG1wL2ltYWdlbGMvaW1ndmll\n' +
    'dzJfOV8xNTkyNTU4NTQ5Mjc3OTY2OV80Nl9bMF2hRlpRAAAAAElFTkSuQmCC" ></image>\n' +
    '</svg>\n');

	editor.ui.registry.addButton('axupimgs', {
		icon: 'axupimgs',
        tooltip: pluginName,
		onAction: function() {
			openDialog();
		}
	});
	editor.ui.registry.addMenuItem('axupimgs', {
		icon: 'axupimgs',
		text: '图片批量上传...',
		onAction: function() {
			openDialog();
		}
	});
	return {
		getMetadata: function() {
			return  {
				name: pluginName,
				url: "http://tinymce.ax-z.cn/more-plugins/axupimgs.php",
			};
		}
	};
});
